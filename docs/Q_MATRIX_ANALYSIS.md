# Q 행렬 구조 분석: 구별 가능 vs 구별 불가능

## 1. 실험 개요

Zero-Expectation QUBO와 Wishart QUBO의 Q 행렬을 직접 비교하여, "구별 가능성"과 "SA 난이도"의 관계를 분석한다.

**실험 스크립트**: `analyze_q_structure.py`

---

## 2. 소규모 예제 (N=5, target="10110")

### Zero-Expectation Q 행렬

```
[[  1.25   2.98  -9.52  -9.28   4.01]
 [  2.98  -4.21   3.44   5.31  -0.89]
 [ -9.52   3.44   0.92 -13.01   7.67]
 [ -9.28   5.31 -13.01  -0.38   5.37]
 [  4.01  -0.89   7.67   5.37  -4.71]]
```

### Wishart Q 행렬 (alpha=0.7)

```
[[-0.17  1.79  0.43 -0.92 -0.95]
 [ 1.79  0.68  1.12 -1.72 -2.54]
 [ 0.43  1.12 -0.09 -0.56 -0.81]
 [-0.92 -1.72 -0.56  1.05  1.11]
 [-0.95 -2.54 -0.81  1.11  1.60]]
```

육안으로도 차이가 보인다:
- Zero-Expectation: 계수 범위가 넓음 (-13 ~ +8), 값이 크다
- Wishart: 계수 범위가 좁음 (-2.5 ~ +1.8), 값이 작다

---

## 3. 대규모 통계 (N=100, 50회 반복)

### 3.1 대각 항 편향

대각 항 $Q_{ii}$가 target 비트 $b_i$에 따라 달라지면, 대각만 봐도 target을 추측할 수 있다.

|  | $E[Q_{ii} \| b_i=0]$ | $E[Q_{ii} \| b_i=1]$ | 차이 (편향) |
|---|---|---|---|
| **Zero-Expectation** | **-2.30** | **+1.93** | **4.23** |
| **Wishart** | -0.06 | -0.04 | **0.01** |

**예상과 반대 결과:**
- **Zero-Expectation이 대각 편향이 훨씬 크다** (4.23 vs 0.01)
- "기댓값 0"이라는 이름과 달리, 비대각 항 $E[Q_{ij}] \approx 0$은 달성했지만 대각 항은 target에 따라 강하게 편향
- 대각 항만 분석해도 target 비트를 높은 정확도로 추측 가능
- Wishart는 오히려 대각 편향이 거의 없음 (0.01)

### 3.2 비대각 항 통계

| | $E[Q_{ij}]$ | $Std[Q_{ij}]$ |
|---|---|---|
| **Zero-Expectation** | -0.01 | **6.57** |
| **Wishart** | 0.00 | **0.33** |

- 두 방법 모두 비대각 항 평균은 ≈ 0
- Zero-Expectation의 계수 표준편차가 Wishart의 약 20배

### 3.3 유효 Rank

| | 유효 Rank ($|\lambda| > 0.01$) |
|---|---|
| **Zero-Expectation** | **100.0 / 100** (full rank) |
| **Wishart** | **99.8 / 100** (거의 full rank) |

N=100, alpha=0.7(M=70)인데 Wishart도 거의 full rank로 보인다. 단, alpha가 낮을수록 rank 구조가 뚜렷해질 것으로 예상.

### 3.4 행간 상관

같은 Q 행렬에서 서로 다른 행의 비대각 원소 간 상관계수:

| | 행간 상관 평균 | 표준편차 |
|---|---|---|
| **Zero-Expectation** | 0.01 | 0.88 |
| **Wishart** | -0.01 | 0.19 |

- 두 방법 모두 평균 상관은 ≈ 0
- Zero-Expectation이 표준편차가 훨씬 큼 → 개별 문제에서 상관이 크게 출렁이지만 평균적으로는 무상관

---

## 4. SA Scaling 실험 결과

동일한 SA 조건 (num_reads=200, num_sweeps=1000)에서 N을 증가시키며 성공률 비교:

### Zero-Expectation

| N | SA 성공률 | 에너지 정확도 | 해밍거리 |
|---|----------|-------------|---------|
| 10 | 100% | 100% | 0 |
| 50 | 100% | 100% | 0 |
| 100 | 100% | 100% | 0 |
| 200 | 100% | 100% | 0 |
| 500 | 100% | 100% | 0 |
| 1000 | 100% | 100% | 0 |

### Wishart (alpha=0.7)

| N | SA 성공률 | 에너지 정확도 | 해밍거리 |
|---|----------|-------------|---------|
| 50 | 100% | 100% | - |
| 100 | **0%** | 92% | N/2 |
| 200 | **0%** | 91.5% | N/2 |
| 500 | **0%** | 91.3% | N/2 |

**N=1000에서도 Zero-Expectation은 SA가 해밍거리 0으로 정확히 ground state를 찾는다.**

---

## 5. 분석: 왜 이런 차이가 나는가

### 5.1 "구별 가능성"과 "SA 난이도"는 다른 것

실험 결과가 보여주는 핵심:

| | 대각 편향 (구별 단서) | SA 난이도 |
|---|---|---|
| Zero-Expectation | **큼** (4.23) | **쉬움** (100%) |
| Wishart | **작음** (0.01) | **어려움** (0%) |

대각 편향이 크면 오히려 SA에게 유리하다. Q_{ii}의 부호가 target 비트 방향을 가리키므로, SA가 에너지 gradient를 따라 자연스럽게 target에 도달한다.

### 5.2 SA 난이도의 본질: 에너지 landscape

**Zero-Expectation의 에너지 landscape:**

```
에너지
  │
  │\
  │ \
  │  \
  │   \___________   ← ground state (단일 깊은 골짜기)
  └────────────────── 상태 공간
```

- 각 (i,j) 페널티가 독립적으로 생성 → 에너지 기여가 서로 간섭하지 않음
- 대각 편향이 target 방향으로 명확한 gradient 제공
- Local minima가 거의 없음 → SA가 직행

**Wishart의 에너지 landscape:**

```
에너지
  │
  │\   /\   /\
  │ \_/  \_/  \
  │  ↑    ↑    \___   ← ground state
  │ trap  trap
  └────────────────── 상태 공간
```

- $J = -(1/N) W W^T$의 low-rank 상관 구조가 metastable 상태 생성
- Metastable 에너지 ≈ ground state의 ~92% (비슷한 깊이)
- 하지만 해밍거리 ≈ N/2 (완전히 다른 위치)
- SA가 탈출하려면 수십 비트를 동시에 뒤집어야 함 → 불가능

### 5.3 상관 구조가 만드는 metastable trap

Wishart에서 $J_{ij} = -(1/N) \sum_\mu W_{i\mu} W_{j\mu}$이므로, 모든 커플링이 공유 벡터 $W$를 통해 상관된다.

이 상관의 결과:
1. 에너지 함수가 몇 개의 **주 방향** (W의 열벡터)으로 지배됨
2. 이 주 방향들이 만드는 부분 공간에 여러 에너지 극소점 존재
3. 극소점들 사이에 높은 에너지 장벽
4. SA는 비트 1개씩만 뒤집으므로 장벽을 넘을 수 없음

Zero-Expectation에서는 각 (i,j) 페널티가 독립이므로 이런 상관 구조가 없다. 따라서 metastable trap도 없다.

---

## 6. 결론

### "구별 가능"과 "SA에게 어려움"은 인과관계가 아니다

| 관계 | 설명 |
|------|------|
| ~~구별 가능 → SA 어려움~~ | **아님.** Wishart는 대각 편향이 작아서 오히려 "구별하기 어려운" 측면이 있지만 SA-hard |
| ~~구별 불가능 → SA 쉬움~~ | **아님.** Zero-Expectation은 대각 편향이 커서 오히려 "구별하기 쉬운" 측면이 있지만 SA-easy |
| **상관 구조 → metastable trap → SA 어려움** | **이것이 본질.** $W W^T$의 low-rank 상관이 에너지 landscape에 trap을 만듦 |
| **독립 구조 → 단순 landscape → SA 쉬움** | **이것이 본질.** 독립 페널티는 trap을 만들지 못함 |

### SA 난이도를 결정하는 요인

1. **Q 계수 간 상관 구조**: 상관이 강할수록 metastable 상태 생성 → 어려움
2. **에너지 landscape의 trap 깊이**: target 에너지와 trap 에너지의 비율 (~92%)
3. **Trap-target 해밍거리**: N/2이면 SA가 도달 불가능

Q 행렬의 1차 통계량(평균, 분산)은 SA 난이도와 직접적 관련이 없다.

---

## 7. 대각 항 기댓값 0은 가능한가?

### 7.1 문제 정의

Zero-Expectation QUBO의 대각 편향이 target 비트를 노출한다는 것을 확인했다. 그렇다면 대각 항도 기댓값 0으로 만들 수 있는가?

목표 조건:
1. E[Q_ij] = 0 (비대각 무편향) — 기존 달성
2. E[Q_ii | b_i=0] = E[Q_ii | b_i=1] (대각 무편향) — 새 목표

### 7.2 페널티 기여 패턴

각 페널티 상태가 Q 행렬에 기여하는 패턴은 구조적으로 고정되어 있다:

| 페널티 상태 | $Q_{ii}$ 기여 | $Q_{jj}$ 기여 | $Q_{ij}$ 기여 |
|------------|--------------|--------------|--------------|
| (0,0) | $-r$ | $-r$ | $+r$ |
| (0,1) | $0$ | $+r$ | $-r$ |
| (1,0) | $+r$ | $0$ | $-r$ |
| (1,1) | $0$ | $0$ | $+r$ |

12개의 ratio 변수를 정의한다:

- Target (0,0): $r_1$=(0,1), $r_2$=(1,0), $r_3$=(1,1)
- Target (0,1): $r_4$=(0,0), $r_5$=(1,0), $r_6$=(1,1)
- Target (1,0): $r_7$=(0,0), $r_8$=(0,1), $r_9$=(1,1)
- Target (1,1): $r_{10}$=(0,0), $r_{11}$=(0,1), $r_{12}$=(1,0)

### 7.3 불가능성 증명

**비대각 무편향 조건** (E[Q_ij] = 0):

$$
\begin{aligned}
(E1)& \quad -r_1 - r_2 + r_3 = 0 &\Rightarrow r_3 = r_1 + r_2 \\
(E2)& \quad r_4 - r_5 + r_6 = 0 &\Rightarrow r_5 = r_4 + r_6 \\
(E3)& \quad r_7 - r_8 + r_9 = 0 &\Rightarrow r_8 = r_7 + r_9 \\
(E4)& \quad r_{10} - r_{11} - r_{12} = 0 &\Rightarrow r_{10} = r_{11} + r_{12}
\end{aligned}
$$

**대각 무편향 조건** (E[Q_ii|b=0] = E[Q_ii|b=1]):

변수 k의 $Q_{kk}$ 기여를 "i" 역할(k < m)에서 분석하면:

| target $(b_k, b_m)$ | $Q_{kk}$ 기여 |
|---------------------|--------------|
| (0,0) | $+r_2$ |
| (0,1) | $-r_4 + r_5$ |
| (1,0) | $-r_7$ |
| (1,1) | $-r_{10} + r_{12}$ |

무편향 조건: $b_k=0$일 때와 $b_k=1$일 때의 기여 합이 같아야 함:

$$r_2 + (-r_4 + r_5) = -r_7 + (-r_{10} + r_{12}) \quad \cdots (D1)$$

**(E2)와 (E4)를 (D1)에 대입:**

$$
r_2 - r_4 + (r_4 + r_6) = -r_7 - (r_{11} + r_{12}) + r_{12}
$$

$$
r_2 + r_6 = -r_7 - r_{11}
$$

$$
\boxed{r_2 + r_6 + r_7 + r_{11} = 0}
$$

**그런데 $r_2, r_6, r_7, r_{11} > 0$ (페널티는 반드시 양수)이므로, 양수의 합이 0이 될 수 없다.**

$$\therefore \text{E}[Q_{ij}]=0 \text{과 대각 무편향을 동시에 달성하는 것은 불가능하다.}$$

### 7.4 실험적 검증

4가지 PenaltyModel에 대해 대각 편향과 비대각 편향을 측정 (N=100, 200회 반복):

**실험 스크립트**: `test_diagonal_zero.py`

| 모델 | $E[Q_{ii}\|b=0]$ | $E[Q_{ii}\|b=1]$ | 대각 편향 | $E[Q_{ij}]$ | 대각 무편향 | 비대각 E=0 |
|------|-----------------|-----------------|----------|------------|-----------|-----------|
| DefaultZeroExpectation | +0.38 | -0.42 | -0.80 | 0.01 | FAIL | **PASS** |
| ZeroOffDiagonal | +198.1 | -198.0 | **-396.0** | 0.00 | FAIL | **PASS** |
| Balanced | +82.7 | -82.6 | -165.4 | 0.34 | FAIL | **PASS** |
| DiagonalUnbiased (새 모델) | +99.2 | +98.6 | -0.60 | -1.49 | FAIL | FAIL |

- 비대각 E=0을 달성하는 모델은 모두 대각 편향이 존재
- 대각 편향을 줄이면 비대각이 틀어짐
- **두 조건을 동시에 PASS하는 모델은 없음** (수학적으로 불가능)

### 7.5 트레이드오프 구조

비대각 무편향을 강하게 달성할수록 대각 편향이 커진다:

| 모델 | 비대각 E[Q_ij] | 대각 편향 크기 |
|------|--------------|-------------|
| ZeroOffDiagonal | **0.00** (완벽) | **396.0** (최악) |
| Balanced | 0.34 | 165.4 |
| DefaultZeroExpectation | 0.01 | 0.80 |
| DiagonalUnbiased | 1.49 | **0.60** (최선) |

이는 페널티 기여 패턴의 구조적 비대칭에서 기인한다:
- $Q_{ij}$는 4가지 페널티 상태 모두에서 기여를 받음 (+, -, -, +)
- $Q_{ii}$는 (0,0)과 (1,0)에서만 기여를 받음 (-, +)
- $Q_{jj}$는 (0,0)과 (0,1)에서만 기여를 받음 (-, +)

이 비대칭 때문에 $Q_{ij}$를 상쇄할 수 있는 자유도와 $Q_{ii}$를 상쇄할 수 있는 자유도가 서로 충돌한다.

### 7.6 의미

1. **페널티 기반 프레임워크의 근본적 한계**: pairwise 페널티 구조를 사용하는 한, "완전한 구별 불가능"은 달성할 수 없다. 비대각 또는 대각 중 하나는 반드시 target 정보를 노출한다.

2. **현재 DefaultZeroExpectationModel이 최선에 가까움**: 대각 편향 0.80으로 4가지 모델 중 가장 작으면서 비대각 E=0을 달성. 다만 N이 커지면 대각 항에 기여하는 이웃 수가 늘어나 편향 탐지가 더 쉬워진다.

3. **완전한 구별 불가능을 위해서는**: pairwise 페널티가 아닌 전혀 다른 구성 방법이 필요하다. 예를 들어 Ising 기반 구성 후 Q 행렬 전체에 대한 통계적 후처리, 또는 higher-order 상호작용을 포함하는 새로운 프레임워크.

---

## 8. 후속 연구 질문

1. **비-pairwise 구성법**: pairwise 페널티 이외의 방법으로 대각+비대각 동시 무편향이 가능한가?
2. **Wishart + 통계 보정**: Wishart Q에 대각/비대각 통계를 보정하는 후처리를 적용하면 ground state가 유지되는가?
3. **탐지 난이도의 정량화**: 현재 대각 편향(0.80)으로 실제로 target을 얼마나 정확히 추측할 수 있는가? SNR 분석 필요.
4. **SA 난이도와의 관계**: 대각 편향을 0으로 만들면 (비대각 편향 허용) SA 난이도가 변하는가?
